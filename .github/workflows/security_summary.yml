name: Weekly Security Summary

on:
  schedule:
    - cron: "0 3 * * 1" # Every Monday 03:00 UTC
  workflow_dispatch:

jobs:
  scan-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        image:
          - name: php-mysql
            context: images/php-mysql
            tag: local-php-mysql
          - name: postgres
            context: images/postgres
            tag: local-postgres
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare reports directory
        run: |
          mkdir -p reports/trivy

      - name: Build ${{ matrix.image.name }} image
        run: |
          docker build -t ${{ matrix.image.tag }} ${{ matrix.image.context }}

      - name: Trivy JSON scan ${{ matrix.image.name }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image.tag }}
          format: "json"
          output: "reports/trivy/${{ matrix.image.name }}.json"

      - name: Trivy SARIF scan ${{ matrix.image.name }} (MEDIUM+)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image.tag }}
          format: "sarif"
          output: "reports/trivy/${{ matrix.image.name }}.sarif"
          exit-code: "0"
          severity: "MEDIUM,HIGH,CRITICAL"

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ matrix.image.name }}
          path: reports/trivy/${{ matrix.image.name }}.*
          retention-days: 7

  generate-summary:
    runs-on: ubuntu-latest
    needs: scan-images
    permissions:
      contents: write
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download all scan artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/trivy
          pattern: trivy-*
          merge-multiple: true

      - name: Upload SARIF (php-mysql)
        if: ${{ hashFiles('reports/trivy/php-mysql.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/php-mysql.sarif
          category: container-security-php-mysql

      - name: Upload SARIF (postgres)
        if: ${{ hashFiles('reports/trivy/postgres.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/postgres.sarif
          category: container-security-postgres

      - name: Generate security summary
        run: |
          python scripts/generate_security_summary.py \
            --trivy reports/trivy/php-mysql.json reports/trivy/postgres.json \
            --previous docs/data/security-summary.json \
            --output docs/data/security-summary.json

      - name: Copy Trivy reports for dashboard access
        run: |
          mkdir -p docs/data/trivy-reports
          cp reports/trivy/php-mysql.json docs/data/trivy-reports/
          cp reports/trivy/postgres-18.json docs/data/trivy-reports/ 2>/dev/null || cp reports/trivy/postgres.json docs/data/trivy-reports/postgres-18.json

      - name: Commit and push summary
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          # Commit dashboard files including trivy reports for CVE details page
          git add docs/data/security-summary.json docs/data/trivy-reports/
          if git diff --cached --quiet; then
            echo 'No changes to commit.'
          else
            git commit -m 'chore(security): weekly security summary update'
            git push
          fi
