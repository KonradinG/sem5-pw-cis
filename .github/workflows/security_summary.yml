name: Weekly Security Summary

on:
  schedule:
    - cron: "0 3 * * 1" # Every Monday 03:00 UTC
  workflow_dispatch:

jobs:
  scan-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        image:
          - name: php-mysql
            context: images/php-mysql
            tag: local-php-mysql
          - name: postgres
            context: images/postgres
            tag: local-postgres
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build ${{ matrix.image.name }} image
        run: |
          docker build -t ${{ matrix.image.tag }} ${{ matrix.image.context }}

      - name: Trivy JSON scan ${{ matrix.image.name }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image.tag }}
          format: "json"
          output: "reports/trivy/${{ matrix.image.name }}.json"

      - name: Trivy SARIF scan ${{ matrix.image.name }} (MEDIUM+)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image.tag }}
          format: "sarif"
          output: "reports/trivy/${{ matrix.image.name }}.sarif"
          exit-code: "0"
          severity: "MEDIUM,HIGH,CRITICAL"

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ matrix.image.name }}
          path: reports/trivy/${{ matrix.image.name }}.*
          retention-days: 7

  generate-summary:
    runs-on: ubuntu-latest
    needs: scan-images
    permissions:
      contents: write
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download all scan artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/trivy
          pattern: trivy-*
          merge-multiple: true

      - name: Merge SARIF files
        run: |
          python - <<'PYMERGE'
          import json, pathlib
          p1 = pathlib.Path('reports/trivy/php-mysql.sarif')
          p2 = pathlib.Path('reports/trivy/postgres.sarif')
          if not p1.exists() or not p2.exists():
              raise SystemExit('Missing SARIF inputs')
          s1 = json.loads(p1.read_text(encoding='utf-8'))
          s2 = json.loads(p2.read_text(encoding='utf-8'))
          # Basic merge: concatenate runs arrays
          merged = {
              **{k: v for k, v in s1.items() if k != 'runs'},
              'runs': s1.get('runs', []) + s2.get('runs', [])
          }
          out = pathlib.Path('reports/trivy/combined.sarif')
          out.write_text(json.dumps(merged, ensure_ascii=False, indent=2), encoding='utf-8')
          print(f'Merged SARIF written to {out} with {len(merged["runs"])} runs.')
          PYMERGE

      - name: Upload combined SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/trivy/combined.sarif

      - name: Generate security summary
        run: |
          python scripts/generate_security_summary.py \
            --trivy reports/trivy/php-mysql.json reports/trivy/postgres.json \
            --previous docs/data/security-summary.json \
            --output docs/data/security-summary.json

      - name: Copy Trivy reports for dashboard access
        run: |
          mkdir -p docs/data/trivy-reports
          cp reports/trivy/php-mysql.json docs/data/trivy-reports/
          cp reports/trivy/postgres-18.json docs/data/trivy-reports/ 2>/dev/null || cp reports/trivy/postgres.json docs/data/trivy-reports/postgres-18.json

      - name: Commit and push summary
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          # Commit dashboard files including trivy reports for CVE details page
          git add docs/data/security-summary.json docs/data/trivy-reports/
          if git diff --cached --quiet; then
            echo 'No changes to commit.'
          else
            git commit -m 'chore(security): weekly security summary update'
            git push
          fi
