name: Weekly Container Security Summary & Dashboard

on:
  schedule:
    - cron: "0 3 * * 1" # Every Monday 03:00 UTC
  workflow_dispatch:

jobs:
  scan-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        image:
          - name: php-mysql
            context: images/php-mysql
            tag: local-8.1-apache-mysql
          - name: postgres-18
            context: images/postgres
            tag: local-postgres-18
          - name: python-3.14
            context: images/python
            tag: local-python-3.14
          - name: vote
            context: example-voting-app-main/vote
            tag: local-vote
          - name: result
            context: example-voting-app-main/result
            tag: local-result
          - name: worker
            context: example-voting-app-main/worker
            tag: local-worker
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare reports directory
        run: |
          mkdir -p reports/trivy

      - name: Build ${{ matrix.image.name }} image
        run: |
          docker build -t ${{ matrix.image.tag }} ${{ matrix.image.context }}

      - name: Trivy JSON scan ${{ matrix.image.name }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image.tag }}
          format: "json"
          output: "reports/trivy/${{ matrix.image.name }}.json"

      - name: Trivy SARIF scan ${{ matrix.image.name }} (MEDIUM+)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image.tag }}
          format: "sarif"
          output: "reports/trivy/${{ matrix.image.name }}.sarif"
          exit-code: "0"
          severity: "MEDIUM,HIGH,CRITICAL"

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ matrix.image.name }}
          path: reports/trivy/${{ matrix.image.name }}.*
          retention-days: 7

  generate-summary:
    runs-on: ubuntu-latest
    needs: scan-images
    permissions:
      contents: write
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download all scan artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/trivy
          pattern: trivy-*
          merge-multiple: true

      - name: Upload SARIF (php-mysql)
        if: ${{ hashFiles('reports/trivy/php-mysql.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/php-mysql.sarif
          category: container-security-php-mysql

      - name: Upload SARIF (postgres)
        if: ${{ hashFiles('reports/trivy/postgres.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/postgres.sarif
          category: container-security-postgres

      - name: Upload SARIF (python)
        if: ${{ hashFiles('reports/trivy/python.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/python.sarif
          category: container-security-python

      - name: Upload SARIF (vote)
        if: ${{ hashFiles('reports/trivy/vote.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/vote.sarif
          category: container-security-vote

      - name: Upload SARIF (result)
        if: ${{ hashFiles('reports/trivy/result.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/result.sarif
          category: container-security-result

      - name: Upload SARIF (worker)
        if: ${{ hashFiles('reports/trivy/worker.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy/worker.sarif
          category: container-security-worker

      - name: Generate security summary
        run: |
          python scripts/generate_security_summary.py \
            --trivy reports/trivy/php-mysql.json reports/trivy/postgres-18.json reports/trivy/python-3.14.json reports/trivy/vote.json reports/trivy/result.json reports/trivy/worker.json \
            --previous docs/data/security-summary.json \
            --output docs/data/security-summary.json

      - name: Copy Trivy reports for dashboard access
        run: |
          mkdir -p docs/data/trivy-reports
          cp reports/trivy/php-mysql.json docs/data/trivy-reports/
          cp reports/trivy/postgres-18.json docs/data/trivy-reports/ 2>/dev/null || true
          cp reports/trivy/python-3.14.json docs/data/trivy-reports/ 2>/dev/null || true
          cp reports/trivy/vote.json docs/data/trivy-reports/ 2>/dev/null || true
          cp reports/trivy/result.json docs/data/trivy-reports/ 2>/dev/null || true
          cp reports/trivy/worker.json docs/data/trivy-reports/ 2>/dev/null || true

      - name: Update CVE baselines
        run: |
          mkdir -p cve-baseline
          DATE=$(date +%Y-%m-%d)

          # Update baseline for each image with standardized names
          for IMAGE_NAME in php-mysql postgres-18 python-3.14 vote result worker; do
            # Map display name to file name
            FILE_NAME="$IMAGE_NAME"
            case "$IMAGE_NAME" in
              php-mysql) FILE_NAME="php-mysql" ;;
              postgres-18) FILE_NAME="postgres-18" ;;
              python-3.14) FILE_NAME="python-3.14" ;;
            esac
            
            FILE="reports/trivy/${IMAGE_NAME}.json"
            if [ -f "$FILE" ]; then
              CRIT=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="CRITICAL")] | length' "$FILE")
              HIGH=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="HIGH")] | length' "$FILE")
              MED=$(jq  '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="MEDIUM")] | length' "$FILE")
              RISK=$((CRIT*5 + HIGH*3 + MED))
              
              CURRENT_CVES=$(jq -r '[.Results[]?.Vulnerabilities? // [] | .[].VulnerabilityID] | unique' "$FILE")
              
              cat > "cve-baseline/${FILE_NAME}.json" <<EOF
          {
            "date": "$DATE",
            "critical": $CRIT,
            "high": $HIGH,
            "medium": $MED,
            "risk_index": $RISK,
            "cves": $CURRENT_CVES
          }
          EOF
            fi
          done

      - name: Commit and push summary
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          # Commit dashboard files including trivy reports and baselines
          git add docs/data/security-summary.json docs/data/trivy-reports/ cve-baseline/
          if git diff --cached --quiet; then
            echo 'No changes to commit.'
          else
            git commit -m 'chore(security): weekly security summary update'
            git push
          fi
