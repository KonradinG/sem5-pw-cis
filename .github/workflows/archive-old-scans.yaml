name: Archive old CVE scans

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # jeden Tag um 03:00 Uhr

concurrency:
  group: archive-old-scans
  cancel-in-progress: true

jobs:
  archive-old-scans:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Archive old scans in issues
        uses: actions/github-script@v7
        with:
          script: |
            // Fetch open security issues (paginate if needed)
            const { owner, repo } = context.repo;
            const issuesResp = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: "security",
              state: "open",
              per_page: 100
            });

            for (const issue of issuesResp.data) {
              const body = issue.body || "";

              // Robust header detection: lines like
              //   ## 2025-11-27
              //   ## Scan 2025-11-27
              const headerLine = /^## (?:Scan\s+)?\d{4}-\d{2}-\d{2}/m;
              const firstIdx = body.search(headerLine);
              if (firstIdx === -1) {
                console.log(`Issue #${issue.number}: no scan headers found.`);
                continue;
              }

              const prefix = body.slice(0, firstIdx).trimEnd();
              const after = body.slice(firstIdx);

              // Split into blocks at each scan header (start-of-line anchored)
              const splitRe = /(?=^## (?:Scan\s+)?\d{4}-\d{2}-\d{2})/gm;
              const scanBlocks = after.split(splitRe);

              if (scanBlocks.length <= 1) {
                console.log(`Issue #${issue.number}: only one scan, nothing to archive.`);
                continue;
              }

              const newestScan = scanBlocks[0];
              const olderScans = scanBlocks.slice(1);

              const wrappedOld = olderScans.map(block => {
                const trimmed = block.trim();
                // Avoid double-wrapping
                if (trimmed.startsWith('<details>')) return trimmed;
                const headerMatch = trimmed.match(/^## (.*)$/m);
                const header = headerMatch ? headerMatch[1].trim() : 'Scan';
                const contents = trimmed.replace(/^## .*\r?\n?/, '');
                return `<details>\n<summary>${header}</summary>\n\n${contents}\n\n</details>`;
              });

              const parts = [];
              if (prefix) parts.push(prefix);
              parts.push(newestScan.trim(), ...wrappedOld);
              const newBody = parts.join("\n\n");

              if (newBody !== body) {
                console.log(`Updating issue #${issue.number}`);
                await github.rest.issues.update({ owner, repo, issue_number: issue.number, body: newBody });
              } else {
                console.log(`Issue #${issue.number} is already cleaned up.`);
              }
            }
