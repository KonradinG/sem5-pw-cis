name: Archive old CVE scans

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # jeden Tag um 03:00 Uhr

jobs:
  archive-old-scans:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Archive old scans in issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: "security",
              state: "open",
              per_page: 100
            });

            for (const issue of issues.data) {
              const body = issue.body || "";

              // Split by Scan headers: "## Scan YYYY-MM-DD"
              const scanBlocks = body.split(/(?=## Scan \d{4}-\d{2}-\d{2})/g);

              if (scanBlocks.length <= 1) {
                console.log(`Issue #${issue.number}: only one scan, nothing to archive.`);
                continue;
              }

              const newestScan = scanBlocks[0];   // always first
              const olderScans = scanBlocks.slice(1);

              const wrappedOld = olderScans.map(block => {
                const lines = block.trim().split("\n");
                const header = lines[0].replace("## ", "").trim();
                const contents = lines.slice(1).join("\n");

                return `<details>\n<summary>${header}</summary>\n\n${contents}\n\n</details>`;
              });

              const newBody = [newestScan.trim(), ...wrappedOld].join("\n\n");

              if (newBody !== body) {
                console.log(`Updating issue #${issue.number}`);
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: newBody
                });
              } else {
                console.log(`Issue #${issue.number} is already cleaned up.`);
              }
            }
