name: SBOM HTML View

# This workflow creates a simple HTML view of the SBOM artifacts
# To remove this feature: simply delete this workflow file

on:
  workflow_run:
    workflows: ["SBOM Generation"]
    types: [completed]
  workflow_dispatch:

jobs:
  generate-html:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download SBOM artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: sbom-*
          path: sbom-temp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Create SBOM directory
        run: mkdir -p docs/sbom

      - name: Generate HTML view
        run: |
          cat > docs/sbom/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="de">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>SBOM - Software Bill of Materials</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
              }
              .container { 
                max-width: 1200px; 
                margin: 0 auto; 
                background: white; 
                padding: 40px; 
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              }
              h1 { 
                color: #2c3e50; 
                margin-bottom: 10px;
                font-size: 2.5em;
              }
              .timestamp { 
                color: #7f8c8d; 
                font-size: 0.95em; 
                margin-bottom: 30px;
                display: block;
              }
              .sbom-section {
                background: #f8f9fa;
                padding: 25px;
                margin: 25px 0;
                border-radius: 12px;
                border-left: 4px solid #3498db;
              }
              .sbom-section h2 {
                color: #34495e;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 12px;
              }
              .badge { 
                padding: 6px 14px; 
                border-radius: 20px; 
                font-size: 0.85em;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
              }
              .badge-ci { background: #e3f2fd; color: #1976d2; }
              .badge-image { background: #f3e5f5; color: #7b1fa2; }
              table { 
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 15px;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              }
              th, td { 
                padding: 14px 16px; 
                text-align: left; 
                border-bottom: 1px solid #ecf0f1;
              }
              th { 
                background: #34495e; 
                color: white; 
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.85em;
                letter-spacing: 0.5px;
              }
              tr:hover { background: #f8f9fa; }
              tr:last-child td { border-bottom: none; }
              code { 
                background: #ecf0f1; 
                padding: 2px 6px; 
                border-radius: 4px;
                font-size: 0.9em;
                color: #e74c3c;
              }
              .footer {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 2px solid #ecf0f1;
                color: #7f8c8d;
                text-align: center;
              }
              .download-link {
                display: inline-block;
                margin: 10px 5px;
                padding: 10px 20px;
                background: #3498db;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 600;
                transition: all 0.3s;
              }
              .download-link:hover {
                background: #2980b9;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
              }
              .loading { 
                text-align: center; 
                padding: 20px; 
                color: #7f8c8d;
                font-style: italic;
              }
              .error { 
                background: #ffe5e5; 
                color: #c0392b; 
                padding: 15px; 
                border-radius: 6px;
                margin: 10px 0;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üìã Software Bill of Materials</h1>
              <span class="timestamp">Generiert am: <span id="timestamp">L√§dt...</span></span>

              <div class="sbom-section">
                <h2>
                  <span class="badge badge-ci">CI/CD Pipeline</span>
                  <span style="font-size: 0.6em; color: #7f8c8d;">GitHub Actions Dependencies</span>
                </h2>
                <table id="ci-table">
                  <thead>
                    <tr><th>Komponente</th><th>Version</th><th>Package URL</th></tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="3" class="loading">‚è≥ L√§dt SBOM-Daten...</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="sbom-section">
                <h2>
                  <span class="badge badge-image">php-mysql Image</span>
                  <span style="font-size: 0.6em; color: #7f8c8d;">Container Dependencies</span>
                </h2>
                <table id="php-table">
                  <thead>
                    <tr><th>Package</th><th>Version</th><th>Typ</th></tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="3" class="loading">‚è≥ L√§dt SBOM-Daten...</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="sbom-section">
                <h2>
                  <span class="badge badge-image">postgres Image</span>
                  <span style="font-size: 0.6em; color: #7f8c8d;">Container Dependencies</span>
                </h2>
                <table id="postgres-table">
                  <thead>
                    <tr><th>Package</th><th>Version</th><th>Typ</th></tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="3" class="loading">‚è≥ L√§dt SBOM-Daten...</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="footer">
                <p><strong>üì¶ SBOM-Dateien herunterladen:</strong></p>
                <a href="sbom-cyclonedx.json" download class="download-link">CI Actions JSON</a>
                <a href="php-mysql.cyclonedx.json" download class="download-link">PHP-MySQL JSON</a>
                <a href="postgres.cyclonedx.json" download class="download-link">Postgres JSON</a>
                <p style="margin-top: 20px; font-size: 0.9em;">
                  üí° Diese SBOMs werden monatlich automatisch aktualisiert
                </p>
              </div>
            </div>

            <script>
              // Set timestamp
              document.getElementById('timestamp').textContent = new Date().toLocaleString('de-DE', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', timeZone: 'UTC', timeZoneName: 'short'
              });

              // Helper function to render table
              function renderTable(tableId, components) {
                const tbody = document.querySelector(`#${tableId} tbody`);
                if (!components || components.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="3" class="error">‚ö†Ô∏è Keine Komponenten gefunden</td></tr>';
                  return;
                }
                
                tbody.innerHTML = '';
                components.slice(0, 100).forEach(c => {  // Limit to 100 for performance
                  const row = tbody.insertRow();
                  row.innerHTML = `
                    <td>${c.name || '-'}</td>
                    <td>${c.version || '-'}</td>
                    <td>${tableId === 'ci-table' ? `<code>${c.purl || '-'}</code>` : (c.type || '-')}</td>
                  `;
                });
                
                if (components.length > 100) {
                  const row = tbody.insertRow();
                  row.innerHTML = `<td colspan="3" style="text-align: center; color: #7f8c8d; font-style: italic;">
                    ... und ${components.length - 100} weitere Komponenten
                  </td>`;
                }
              }

              // Load CI Actions SBOM
              fetch('sbom-cyclonedx.json')
                .then(r => r.json())
                .then(data => {
                  renderTable('ci-table', data.components);
                })
                .catch(err => {
                  document.querySelector('#ci-table tbody').innerHTML = 
                    '<tr><td colspan="3" class="error">‚ùå SBOM konnte nicht geladen werden</td></tr>';
                });

              // Load php-mysql SBOM
              fetch('php-mysql.cyclonedx.json')
                .then(r => r.json())
                .then(data => {
                  renderTable('php-table', data.components);
                })
                .catch(err => {
                  document.querySelector('#php-table tbody').innerHTML = 
                    '<tr><td colspan="3" class="error">‚ùå SBOM konnte nicht geladen werden</td></tr>';
                });

              // Load postgres SBOM
              fetch('postgres.cyclonedx.json')
                .then(r => r.json())
                .then(data => {
                  renderTable('postgres-table', data.components);
                })
                .catch(err => {
                  document.querySelector('#postgres-table tbody').innerHTML = 
                    '<tr><td colspan="3" class="error">‚ùå SBOM konnte nicht geladen werden</td></tr>';
                });
            </script>
          </body>
          </html>
          EOF

      - name: Copy SBOM JSON files
        run: |
          # Copy CI Actions SBOM
          if [ -f "sbom-temp/sbom-cyclonedx/sbom-cyclonedx.json" ]; then
            cp sbom-temp/sbom-cyclonedx/sbom-cyclonedx.json docs/sbom/
            echo "‚úÖ CI Actions SBOM copied"
          else
            echo "‚ö†Ô∏è CI Actions SBOM not found"
          fi

          # Copy Image SBOMs
          if [ -f "sbom-temp/sbom-images-cyclonedx/php-mysql.cyclonedx.json" ]; then
            cp sbom-temp/sbom-images-cyclonedx/php-mysql.cyclonedx.json docs/sbom/
            echo "‚úÖ php-mysql SBOM copied"
          else
            echo "‚ö†Ô∏è php-mysql SBOM not found"
          fi

          if [ -f "sbom-temp/sbom-images-cyclonedx/postgres.cyclonedx.json" ]; then
            cp sbom-temp/sbom-images-cyclonedx/postgres.cyclonedx.json docs/sbom/
            echo "‚úÖ postgres SBOM copied"
          else
            echo "‚ö†Ô∏è postgres SBOM not found"
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/sbom/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update SBOM HTML view [skip ci]"
            git push
          fi
