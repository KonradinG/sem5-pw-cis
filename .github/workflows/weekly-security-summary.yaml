name: Weekly Security Summary

on:
  schedule:
    - cron: "0 0 * * 0" # Sonntag 00:00 UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  weekly-summary:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # âœ… Trivy CLI sauber installieren (kein Action-Wrapping)
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release jq
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key \
            | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb \
            $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      # âœ… Images scannen & Zahlen einsammeln
      - name: Scan images and collect CVEs
        run: |
          set -e
          mkdir -p out

          echo "image,medium,high,critical" > out/current.csv

          declare -A images

          # âœ… PostgreSQL
          images[postgres]="$(awk '/^FROM / {print $2; exit}' images/postgres/Dockerfile)"

          # âœ… PHP / MySQL (Multi-Stage sicher!)
          images[php-mysql]="$(awk '/^FROM php:/ {print $2; exit}' images/php-mysql/Dockerfile)"

          for name in "${!images[@]}"; do
            image="${images[$name]}"
            echo "ğŸ” Scanning $image"

            trivy image \
              --scanners vuln \
              --severity MEDIUM,HIGH,CRITICAL \
              --format json \
              "$image" > out/$name.json

            m=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' out/$name.json)
            h=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' out/$name.json)
            c=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' out/$name.json)

            echo "$name,$m,$h,$c" >> out/current.csv
          done

      # âœ… Weekly Issue + Verlauf + Trend
      - name: Update weekly security summary issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const rows = fs.readFileSync("out/current.csv", "utf8")
              .trim().split("\n").slice(1)
              .map(r => {
                const [img,m,h,c] = r.split(",");
                return {img, m:+m, h:+h, c:+c};
              });

            const title = "Weekly Security Summary";

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "security-summary"
            });

            let issue = issues.find(i => i.title === title);

            if (!issue) {
              issue = (await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                labels: ["security", "security-summary"],
                body: "## ğŸ›¡ Weekly Security Summary\nAutomatisch erzeugter CVE-Verlauf pro Image."
              })).data;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });

            let previous = {};
            if (comments.length) {
              const last = comments.at(-1).body;
              for (const r of rows) {
                const m = last.match(
                  new RegExp(`${r.img}\\s*\\|\\s*(\\d+)\\s*\\|\\s*(\\d+)\\s*\\|\\s*(\\d+)`)
                );
                if (m) previous[r.img] = {m:+m[1], h:+m[2], c:+m[3]};
              }
            }

            let body = `### ğŸ“… ${new Date().toISOString().slice(0,10)}\n\n`;
            body += "| Image | MEDIUM | HIGH | CRITICAL | Trend |\n";
            body += "|------|--------|------|----------|-------|\n";

            for (const r of rows) {
              const p = previous[r.img] || {m:0,h:0,c:0};
              const delta = (r.m+r.h+r.c) - (p.m+p.h+p.c);
              const trend = delta > 0 ? "ğŸ”º" : delta < 0 ? "ğŸŸ¢" : "â–";
              body += `| ${r.img} | ${r.m} | ${r.h} | ${r.c} | ${trend} |\n`;
            }

            body += `
            **Security Policy**
            - ğŸ”´ CRITICAL = Hard Block
            - âœ… Auto-Merge nur bei sinkender CVE-Anzahl
            - ğŸ“ˆ WÃ¶chentliche Trendanalyse
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body
            });
