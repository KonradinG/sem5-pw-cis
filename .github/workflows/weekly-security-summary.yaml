name: Weekly Security Summary

on:
  schedule:
    - cron: "0 0 * * 0" # Sunday 00:00 UTC
  workflow_dispatch:

jobs:
  weekly-summary:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.1

      - name: Prepare directories
        run: |
          mkdir -p docs/data
          mkdir -p .tmp

      - name: Scan images and collect CVE counts
        run: |
          set -e

          echo '{}' > .tmp/current.json

          scan_image () {
            NAME=$1
            IMAGE=$2

            trivy image \
              --scanners vuln \
              --severity MEDIUM,HIGH,CRITICAL \
              --format json \
              "$IMAGE" > .tmp/$NAME.json

            MEDIUM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' .tmp/$NAME.json)
            HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' .tmp/$NAME.json)
            CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' .tmp/$NAME.json)

            jq \
              --arg name "$NAME" \
              --argjson m "$MEDIUM" \
              --argjson h "$HIGH" \
              --argjson c "$CRITICAL" \
              '. + {($name): {medium:$m, high:$h, critical:$c}}' \
              .tmp/current.json > .tmp/tmp.json

            mv .tmp/tmp.json .tmp/current.json
          }

          POSTGRES_TAG=$(grep '^FROM postgres:' images/postgres/Dockerfile | cut -d: -f2)
          PHP_TAG=$(grep '^FROM php:' images/php-mysql/Dockerfile | head -1 | cut -d: -f2)

          scan_image "postgres-secured" "postgres:${POSTGRES_TAG}"
          scan_image "php-mysql-secured" "php:${PHP_TAG}"

      - name: Update security-summary.json
        run: |
          DATE=$(date +%F)

          if [ ! -f docs/data/security-summary.json ]; then
            cat <<EOF > docs/data/security-summary.json
            {
              "generated": "$DATE",
              "images": [],
              "trend": []
            }
            EOF
          fi

          CURRENT=$(cat .tmp/current.json)

          IMAGES=$(jq -n --argjson cur "$CURRENT" '
            [
              {
                name: "postgres-secured",
                critical: $cur["postgres-secured"].critical,
                high: $cur["postgres-secured"].high,
                medium: $cur["postgres-secured"].medium
              },
              {
                name: "php-mysql-secured",
                critical: $cur["php-mysql-secured"].critical,
                high: $cur["php-mysql-secured"].high,
                medium: $cur["php-mysql-secured"].medium
              }
            ]
          ')

          TREND_ENTRY=$(jq -n --arg date "$DATE" --argjson cur "$CURRENT" '
            {
              date: $date,
              critical: ($cur["postgres-secured"].critical + $cur["php-mysql-secured"].critical),
              high: ($cur["postgres-secured"].high + $cur["php-mysql-secured"].high),
              medium: ($cur["postgres-secured"].medium + $cur["php-mysql-secured"].medium)
            }
          ')

          jq \
            --argjson images "$IMAGES" \
            --argjson trendEntry "$TREND_ENTRY" \
            '.generated = "'$DATE'" |
             .images = $images |
             .trend += [$trendEntry]' \
            docs/data/security-summary.json > .tmp/final.json

          mv .tmp/final.json docs/data/security-summary.json

      - name: Update Weekly Summary Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const data = JSON.parse(fs.readFileSync("docs/data/security-summary.json"));

            let body = `# Weekly Security Summary\n\nGenerated: ${data.generated}\n\n`;
            body += "| Image | CRITICAL | HIGH | MEDIUM |\n";
            body += "|------|----------|------|--------|\n";

            for (const img of data.images) {
              body += `| ${img.name} | ${img.critical} | ${img.high} | ${img.medium} |\n`;
            }

            let issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            let issue = issues.data.find(i => i.title === "Weekly Security Summary");

            if (issue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Weekly Security Summary",
                body,
                labels: ["security", "summary"]
              });
            }

      - name: Commit security summary
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs/data/security-summary.json

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Weekly security summary update"
            git push
          fi
