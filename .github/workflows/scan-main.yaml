name: Container Security Scan (push/schedule)

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  scan-main:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - image_tag: postgres-18
            docker_context: images/postgres
            docker_file: images/postgres/Dockerfile

          - image_tag: 8.1-apache-mysql
            docker_context: images/php-mysql
            docker_file: images/php-mysql/Dockerfile

    steps:
      # ===============================
      # Checkout
      # ===============================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===============================
      # Docker
      # ===============================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ===============================
      # Trivy install + cache
      # ===============================
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.1

      # ===============================
      # Build image (LOCAL â€“ Option A)
      # ===============================
      - name: Build Docker image (local)
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.docker_context }}
          file: ${{ matrix.docker_file }}
          load: true
          push: false
          tags: main-${{ matrix.image_tag }}

      # ===============================
      # Trivy scan
      # ===============================
      - name: Trivy scan (local image, JSON)
        run: |
          trivy image \
            --scanners vuln \
            --format json \
            --output trivy-${{ matrix.image_tag }}.json \
            main-${{ matrix.image_tag }}

      # ===============================
      # CVE Gate ðŸ”´ fail ONLY on CRITICAL
      # ===============================
      - name: CVE gate (block on CRITICAL)
        run: |
          CRIT=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="CRITICAL")] | length' trivy-${{ matrix.image_tag }}.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="HIGH")] | length' trivy-${{ matrix.image_tag }}.json)
          MED=$(jq  '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="MEDIUM")] | length' trivy-${{ matrix.image_tag }}.json)

          echo "CRITICAL=$CRIT HIGH=$HIGH MEDIUM=$MED"

          if [ "$CRIT" -gt 0 ]; then
            echo "âŒ CRITICAL vulnerabilities found â€“ blocking pipeline"
            exit 1
          else
            echo "âœ… No CRITICAL vulnerabilities â€“ pipeline allowed"
          fi

      # ===============================
      # Write vulnerability table
      # ===============================
      - name: Extract MEDIUM+ vulnerabilities
        run: |
          jq -r '
            .Results[]?.Vulnerabilities? // [] |
            map(select(.Severity=="CRITICAL" or .Severity=="HIGH" or .Severity=="MEDIUM")) |
            sort_by(
              if .Severity=="CRITICAL" then 0
              elif .Severity=="HIGH" then 1
              else 2 end
            ) |
            map("| \(.Severity) | [\(.VulnerabilityID)](\(.PrimaryURL)) | \(.PkgName) | \(.InstalledVersion) |")
            | .[]
          ' trivy-${{ matrix.image_tag }}.json > vuln-table.txt

          if [ ! -s vuln-table.txt ]; then
            echo "| NONE | - | - | - |" > vuln-table.txt
          fi

      # ===============================
      # Baseline + Audit Logs + Risk Index
      # ===============================
      - name: Update CVE baseline & audit logs
        run: |
          mkdir -p cve-baseline audit-logs
          FILE="trivy-${{ matrix.image_tag }}.json"
          TAG="${{ matrix.image_tag }}"
          DATE=$(date +%Y-%m-%d)

          CRIT=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="CRITICAL")] | length' "$FILE")
          HIGH=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="HIGH")] | length' "$FILE")
          MED=$(jq  '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="MEDIUM")] | length' "$FILE")

          RISK=$((CRIT*5 + HIGH*3 + MED))

          # Extract current CVE IDs
          CURRENT_CVES=$(jq -r '[.Results[]?.Vulnerabilities? // [] | .[].VulnerabilityID] | unique | .[]' "$FILE" | sort)

          # Extract previous CVE IDs from baseline (not audit log)
          BASELINE="cve-baseline/${TAG}.json"
          PREVIOUS_CVES=""
          if [ -f "$BASELINE" ]; then
            PREVIOUS_CVES=$(jq -r '.cves // []' "$BASELINE" 2>/dev/null | jq -r '.[]' | sort)
          fi
          fi

          # Detect lifecycle changes
          NEW_CVES=$(comm -23 <(echo "$CURRENT_CVES") <(echo "$PREVIOUS_CVES") | head -10)
          FIXED_CVES=$(comm -13 <(echo "$CURRENT_CVES") <(echo "$PREVIOUS_CVES") | head -10)

          # Build lifecycle section
          LIFECYCLE=""
          if [ -n "$NEW_CVES" ]; then
            LIFECYCLE="$LIFECYCLE\n#### ðŸ†• Neu erkannte CVEs\n"
            echo "$NEW_CVES" | while read cve; do
              LIFECYCLE="$LIFECYCLE- $cve\n"
            done
          fi
          if [ -n "$FIXED_CVES" ]; then
            LIFECYCLE="$LIFECYCLE\n#### âœ… Behobene CVEs\n"
            echo "$FIXED_CVES" | while read cve; do
              LIFECYCLE="$LIFECYCLE- $cve\n"
            done
          fi

          # Extract top CVEs with details (validate CVE ID format before linking)
          TOP_CVES=$(jq -r '
            [.Results[]?.Vulnerabilities? // [] | .[] | 
            select(.Severity == "CRITICAL" or .Severity == "HIGH")] |
            sort_by(.Severity) | reverse | .[0:5] |
            .[] | 
            if (.VulnerabilityID | test("^CVE-[0-9]{4}-[0-9]{4,}$")) then
              "- **[\(.VulnerabilityID)](\(.PrimaryURL // "https://nvd.nist.gov/vuln/detail/\(.VulnerabilityID)"))** (\(.Severity)) - `\(.PkgName)@\(.InstalledVersion)` | CVSS: \(.CVSS.nvd.V3Score // .CVSS.redhat.V3Score // "N/A") | Fix: \(.FixedVersion // "Pending")"
            else
              "- **\(.VulnerabilityID)** (\(.Severity)) - `\(.PkgName)@\(.InstalledVersion)` | CVSS: \(.CVSS.nvd.V3Score // .CVSS.redhat.V3Score // "N/A") | Fix: \(.FixedVersion // "Pending")"
            end
          ' "$FILE" 2>/dev/null || echo "- Keine CRITICAL/HIGH Vulnerabilities")

          {
            echo "## $DATE"
            echo "CRITICAL=$CRIT HIGH=$HIGH MEDIUM=$MED RISK_INDEX=$RISK"
            echo ""
            if [ -n "$LIFECYCLE" ]; then
              echo "### ðŸ”„ Lifecycle Changes"
              echo -e "$LIFECYCLE"
            fi
            echo "### ðŸ”´ Top Critical/High Vulnerabilities"
            echo "$TOP_CVES"
            echo "---"
            echo
            cat "$AUDIT"
          } > tmp && mv tmp "$AUDIT"

          # Update baseline with current scan (this prevents "always new" bug)
          CURRENT_CVES_JSON=$(echo "$CURRENT_CVES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          cat > "$BASELINE" <<EOF
          {
            "date": "$DATE",
            "critical": $CRIT,
            "high": $HIGH,
            "medium": $MED,
            "risk_index": $RISK,
            "cves": $CURRENT_CVES_JSON
          }
          EOF

      # Create / update CVE Issue
      # ===============================
      - name: Create or update CVE issue (MEDIUM+)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const imageTag = "${{ matrix.image_tag }}";
            const label = `image:${imageTag}`;
            const table = fs.readFileSync("vuln-table.txt", "utf8");

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: label,
              state: "open"
            });

            const block = `
            ## Scan ${new Date().toISOString().split("T")[0]}

            | Severity | CVE | Package | Installed Version |
            |----------|-----|---------|-------------------|
            ${table}
            `;

            if (issues.length) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: (issues[0].body || "") + block
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Security alerts: ${imageTag}`,
                body: block,
                labels: ["security", "trivy", label]
              });
            }

      # ===============================
      # Commit baselines & audit logs
      # ===============================
      - name: Commit CVE baselines & audit logs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add cve-baseline audit-logs
          git diff --staged --quiet || git commit -m "Update CVE baselines & audit logs"
          git push || true
