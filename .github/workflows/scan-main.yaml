name: scan-main

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  scan-main:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - image_tag: postgres-18
            docker_context: images/postgres
            docker_file: images/postgres/Dockerfile

          - image_tag: 8.1-apache-mysql
            docker_context: images/php-mysql
            docker_file: images/php-mysql/Dockerfile

    steps:
      # ===============================
      # Checkout
      # ===============================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===============================
      # Docker setup
      # ===============================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ===============================
      # Trivy install + cache
      # ===============================
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.1

      # ===============================
      # Build image LOCALLY (Option A)
      # ===============================
      - name: Build Docker image (local)
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.docker_context }}
          file: ${{ matrix.docker_file }}
          load: true # âœ… wichtig
          push: false
          tags: main-${{ matrix.image_tag }}

      # ===============================
      # Trivy scan (local image)
      # ===============================
      - name: Trivy scan (local image, JSON)
        run: |
          trivy image \
            --scanners vuln \
            --format json \
            --output trivy-${{ matrix.image_tag }}.json \
            main-${{ matrix.image_tag }}

      # ===============================
      # Baseline + Audit Logs + Risk Index + CVSS
      # ===============================
      - name: Update CVE baseline & audit logs
        run: |
          set -e
          mkdir -p cve-baseline audit-logs

          FILE="trivy-${{ matrix.image_tag }}.json"
          TAG="${{ matrix.image_tag }}"
          DATE=$(date +%Y-%m-%d)

          CRIT=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="CRITICAL")] | length' "$FILE")
          HIGH=$(jq '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="HIGH")] | length' "$FILE")
          MED=$(jq  '[.Results[]?.Vulnerabilities? // [] | .[] | select(.Severity=="MEDIUM")] | length' "$FILE")

          MAX_CVSS=$(jq '
            [
              .Results[]?.Vulnerabilities? // [] |
              .[] |
              (
                .CVSS?.nvd?.V3Score //
                .CVSS?.redhat?.V3Score //
                .CVSS?.github?.V3Score //
                0
              )
            ] | max // 0
          ' "$FILE")

          RISK=$((CRIT*5 + HIGH*3 + MED))

          cat > cve-baseline/${TAG}.json <<EOF
          {
            "date": "$DATE",
            "critical": $CRIT,
            "high": $HIGH,
            "medium": $MED,
            "risk_index": $RISK,
            "max_cvss_v3": $MAX_CVSS
          }
          EOF

          AUDIT="audit-logs/${TAG}.md"
          touch "$AUDIT"
          {
            echo "## $DATE"
            echo "CRITICAL=$CRIT HIGH=$HIGH MEDIUM=$MED RISK_INDEX=$RISK MAX_CVSS_V3=$MAX_CVSS"
            echo "---"
            echo
            cat "$AUDIT"
          } > tmp && mv tmp "$AUDIT"

      # ===============================
      # Extract MEDIUM+ CVEs for Issue
      # ===============================
      - name: Extract vulnerability table (MEDIUM+)
        id: vulns
        run: |
          TABLE=$(jq -r '
            .Results[]?.Vulnerabilities? // [] |
            map(select(.Severity=="CRITICAL" or .Severity=="HIGH" or .Severity=="MEDIUM")) |
            sort_by(
              if .Severity=="CRITICAL" then 0
              elif .Severity=="HIGH" then 1
              else 2 end
            ) |
            map("| \(.Severity) | [\(.VulnerabilityID)](\(.PrimaryURL)) | \(.PkgName) | \(.InstalledVersion) |")
            | .[]
          ' trivy-${{ matrix.image_tag }}.json)

          echo "TABLE<<EOF" >> $GITHUB_OUTPUT
          echo "${TABLE:-| NONE | - | - | - |}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ===============================
      # Open / Update Security Issue
      # ===============================
      - name: Create or update CVE issue (MEDIUM+)
        uses: actions/github-script@v7
        env:
          IMAGE_TAG: ${{ matrix.image_tag }}
          TABLE: ${{ steps.vulns.outputs.TABLE }}
        with:
          script: |
            const label = `image:${process.env.IMAGE_TAG}`;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: label,
              state: "open"
            });

            const block = `
            ## Scan ${new Date().toISOString().split("T")[0]}

            | Severity | CVE | Package | Installed Version |
            |----------|-----|---------|-------------------|
            ${process.env.TABLE}
            `;

            if (issues.length) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: (issues[0].body || "") + block
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: \`Security alerts: ${process.env.IMAGE_TAG}\`,
                body: block,
                labels: ["security", "trivy", label]
              });
            }

      # ===============================
      # Commit Baseline & Audit Logs
      # ===============================
      - name: Commit CVE baselines & audit logs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add cve-baseline audit-logs
          git diff --staged --quiet || git commit -m "Update CVE baselines & audit logs"
          git push || true
