name: deploy-security-dashboard

on:
  workflow_run:
    workflows: ["weekly-security-summary"]
    types: [completed]

jobs:
  dashboard:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Build dashboard
        run: |
          mkdir -p public
          cp -r audit-logs cve-baseline security-summary public/

          cat > public/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Security Dashboard</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          </head>
          <body>
            <h1>Security Risk Trend</h1>
            <canvas id="riskChart"></canvas>

            <script>
              async function load() {
                const res = await fetch("audit-logs/postgres-18.md");
                const text = await res.text();

                const labels = [];
                const risks = [];

                text.split("## ").slice(1).forEach(block => {
                  const lines = block.split("\n");
                  const date = lines[0].trim();
                  const match = block.match(/RISK_INDEX=(\d+)/);

                  if (match) {
                    labels.push(date);
                    risks.push(Number(match[1]));
                  }
                });

                new Chart(document.getElementById("riskChart"), {
                  type: "line",
                  data: {
                    labels: labels.reverse(),
                    datasets: [{
                      label: "Risk Index",
                      borderColor: "red",
                      fill: false,
                      data: risks.reverse()
                    }]
                  }
                });
              }
              load();
            </script>
          </body>
          </html>
          EOF

      - uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - uses: actions/deploy-pages@v4
