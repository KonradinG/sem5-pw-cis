name: pr-security-compare

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  detect-changes:
    name: Detect changed Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      postgres: ${{ steps.filter.outputs.postgres }}
      php_mysql: ${{ steps.filter.outputs.php_mysql }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            postgres:
              - images/postgres/Dockerfile
            php_mysql:
              - images/php-mysql/Dockerfile

  compare:
    name: compare
    needs: detect-changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: postgres-18
            dockerfile: images/postgres/Dockerfile
            context: images/postgres
            enabled: ${{ needs.detect-changes.outputs.postgres == 'true' }}

          - name: 8.1-apache-mysql
            dockerfile: images/php-mysql/Dockerfile
            context: images/php-mysql
            enabled: ${{ needs.detect-changes.outputs.php_mysql == 'true' }}

    if: matrix.enabled == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.1

      ##################################
      # Build BASE image (main branch)
      ##################################
      - name: Build BASE image
        run: |
          docker build \
            -f ${{ matrix.dockerfile }} \
            -t base-${{ matrix.name }}:latest \
            ${{ matrix.context }}

      ##################################
      # Build PR image
      ##################################
      - name: Build PR image
        run: |
          docker build \
            -f ${{ matrix.dockerfile }} \
            -t pr-${{ matrix.name }}:latest \
            ${{ matrix.context }}

      ##################################
      # Scan BASE
      ##################################
      - name: Scan BASE image
        run: |
          trivy image \
            --scanners vuln \
            --severity MEDIUM,HIGH,CRITICAL \
            --format json \
            --output base.json \
            base-${{ matrix.name }}:latest

      ##################################
      # Scan PR
      ##################################
      - name: Scan PR image
        run: |
          trivy image \
            --scanners vuln \
            --severity MEDIUM,HIGH,CRITICAL \
            --format json \
            --output pr.json \
            pr-${{ matrix.name }}:latest

      ##################################
      # Compare CVEs
      ##################################
      - name: Compare risk & CVEs
        id: compare
        run: |
          BASE=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity!="LOW")] | length' base.json)
          PR=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity!="LOW")] | length' pr.json)

          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "pr=$PR" >> $GITHUB_OUTPUT

          if [ "$PR" -gt "$BASE" ]; then
            echo " PR has more vulnerabilities"
            exit 1
          else
            echo " PR is safe"
          fi

      ##################################
      # Comment on PR
      ##################################
      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          BASE: ${{ steps.compare.outputs.base }}
          PRC: ${{ steps.compare.outputs.pr }}
          IMAGE: ${{ matrix.name }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `
              ### Security comparison for **${process.env.IMAGE}**

              | Scan | MEDIUM+ CVEs |
              |-----:|-------------:|
              | Base | ${process.env.BASE} |
              | PR   | ${process.env.PRC} |

              **Result:** SAFE â€“ can be merged
              `
            })
