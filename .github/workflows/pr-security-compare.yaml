name: PR Security Comparison

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    # Detect which images have been changed in the PR
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            postgres:
              - images/postgres/**
            php-mysql:
              - images/php-mysql/**
            python:
              - images/python/**
            vote:
              - example-voting-app-main/vote/**
            result:
              - example-voting-app-main/result/**
            worker:
              - example-voting-app-main/worker/**

      - name: Build dynamic matrix
        id: matrix
        run: |
          MATRIX='{"include":[]}'

          if [ "${{ steps.filter.outputs.postgres }}" = "true" ]; then
            MATRIX=$(jq '.include += [{"name":"postgres","context":"images/postgres","dockerfile":"images/postgres/Dockerfile"}]' <<< "$MATRIX")
          fi

          if [ "${{ steps.filter.outputs.php-mysql }}" = "true" ]; then
            MATRIX=$(jq '.include += [{"name":"php-mysql","context":"images/php-mysql","dockerfile":"images/php-mysql/Dockerfile"}]' <<< "$MATRIX")
          fi

          if [ "${{ steps.filter.outputs.python }}" = "true" ]; then
            MATRIX=$(jq '.include += [{"name":"python","context":"images/python","dockerfile":"images/python/Dockerfile"}]' <<< "$MATRIX")
          fi
            
          if [ "${{ steps.filter.outputs.vote }}" = "true" ]; then
            MATRIX=$(jq '.include += [{"name":"vote","context":"example-voting-app-main/vote","dockerfile":"example-voting-app-main/vote/Dockerfile"}]' <<< "$MATRIX")
          fi

          if [ "${{ steps.filter.outputs.result }}" = "true" ]; then
            MATRIX=$(jq '.include += [{"name":"result","context":"example-voting-app-main/result","dockerfile":"example-voting-app-main/result/Dockerfile"}]' <<< "$MATRIX")
          fi

          if [ "${{ steps.filter.outputs.worker }}" = "true" ]; then
            MATRIX=$(jq '.include += [{"name":"worker","context":"example-voting-app-main/worker","dockerfile":"example-voting-app-main/worker/Dockerfile"}]' <<< "$MATRIX")
          fi

          # Remove whitespace and output as single line
          echo "matrix=$(echo "$MATRIX" | jq -c .)" >> $GITHUB_OUTPUT

  compare:
    needs: detect-changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    if: needs.detect-changes.outputs.matrix != '{"include":[]}'

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.1

      # === BUILD BASE (main) ===
      - name: Build base image (main)
        run: |
          git fetch origin main
          git checkout origin/main

          docker build \
            -t base-${{ matrix.name }} \
            -f ${{ matrix.dockerfile }} \
            ${{ matrix.context }}

      - name: Scan base image
        run: |
          trivy image \
            --scanners vuln \
            --format json \
            --output base.json \
            base-${{ matrix.name }}

      # === BUILD PR IMAGE ===
      - name: Build PR image
        run: |
          git fetch origin ${{ github.head_ref }}:${{ github.head_ref }}
          git checkout ${{ github.head_ref }}

          docker build \
            -t pr-${{ matrix.name }} \
            -f ${{ matrix.dockerfile }} \
            ${{ matrix.context }}

      - name: Scan PR image
        run: |
          trivy image \
            --scanners vuln \
            --format json \
            --output pr.json \
            pr-${{ matrix.name }}

      # === COMPARE ===
      - name: Compare CVEs (STRICT)
        id: compare
        run: |
          BASE_TOTAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity!="LOW")] | length' base.json)
          PR_TOTAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity!="LOW")] | length' pr.json)
          PR_CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' pr.json)

          echo "BASE_TOTAL=$BASE_TOTAL" >> $GITHUB_ENV
          echo "PR_TOTAL=$PR_TOTAL" >> $GITHUB_ENV
          echo "PR_CRITICAL=$PR_CRITICAL" >> $GITHUB_ENV

          echo "Base CVEs: $BASE_TOTAL"
          echo "PR CVEs:   $PR_TOTAL"
          echo "CRITICAL:  $PR_CRITICAL"

          # HARD BLOCK
          if [ "$PR_CRITICAL" -gt 0 ]; then
            echo " CRITICAL vulnerabilities present"
            exit 1
          fi

          # MUST improve
          if [ "$PR_TOTAL" -ge "$BASE_TOTAL" ]; then
            echo " CVE count not improved"
            exit 1
          fi

          echo " Security improved"

      # === COMMENT ===
      - name: Comment result
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: [
                ` **Security improvement detected for \`${{ matrix.name }}\`**`,
                ``,
                `• Base CVEs: **${process.env.BASE_TOTAL}**`,
                `• PR CVEs: **${process.env.PR_TOTAL}**`,
                `• CRITICAL: **0**`,
                ``,
                `Safe to merge `
              ].join("\n")
            })

      # === ENABLE AUTOMERGE ===
      - name: Enable automerge
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.enableAutoMerge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: "squash"
            })
