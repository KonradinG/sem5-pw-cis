name: pr-security-compare

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  compare:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: postgres-18
            dockerfile: images/postgres/Dockerfile
            context: images/postgres
            filter: postgres

          - name: 8.1-apache-mysql
            dockerfile: images/php-mysql/Dockerfile
            context: images/php-mysql
            filter: php_mysql

    steps:
      # Repo holen
      - name: Checkout
        uses: actions/checkout@v4

      # Welche Images wurden geändert?
      - name: Detect changed Dockerfiles
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            postgres:
              - 'images/postgres/**'
            php_mysql:
              - 'images/php-mysql/**'

      # Skip wenn dieses Image nicht betroffen ist
      - name: Skip irrelevant image
        if: steps.changes.outputs[matrix.filter] != 'true'
        run: |
          echo "Image ${{ matrix.name }} not changed – skipping"
          exit 0

      # Buildx
      - uses: docker/setup-buildx-action@v3

      # Trivy installieren
      - uses: aquasecurity/setup-trivy@v0.2.1

      # BASE IMAGE bauen
      - name: Build BASE image
        run: |
          docker build \
            -t base-${{ matrix.name }} \
            -f ${{ matrix.dockerfile }} \
            ${{ matrix.context }}

      # BASE scan
      - name: Scan BASE image
        run: |
          trivy image \
            --scanners vuln \
            --severity MEDIUM,HIGH,CRITICAL \
            --format json \
            --output base-${{ matrix.name }}.json \
            base-${{ matrix.name }}

      # PR IMAGE bauen
      - name: Build PR image
        run: |
          docker build \
            -t pr-${{ matrix.name }} \
            -f ${{ matrix.dockerfile }} \
            ${{ matrix.context }}

      # PR scan
      - name: Scan PR image
        run: |
          trivy image \
            --scanners vuln \
            --severity MEDIUM,HIGH,CRITICAL \
            --format json \
            --output pr-${{ matrix.name }}.json \
            pr-${{ matrix.name }}

      # CVE vergleichen
      - name: Compare CVEs
        id: compare
        run: |
          base=$(jq '[.Results[].Vulnerabilities[]?] | length' base-${{ matrix.name }}.json)
          pr=$(jq '[.Results[].Vulnerabilities[]?] | length' pr-${{ matrix.name }}.json)

          echo "base=$base"
          echo "pr=$pr"

          echo "base=$base" >> $GITHUB_OUTPUT
          echo "pr=$pr" >> $GITHUB_OUTPUT

          if [ "$pr" -gt "$base" ]; then
            echo "SECURITY REGRESSION"
            exit 1
          fi

      # Kommentar in PR
      - name: Comment result
        uses: actions/github-script@v7
        with:
          script: |
            const base = Number("${{ steps.compare.outputs.base }}");
            const pr = Number("${{ steps.compare.outputs.pr }}");

            const body = `
            **Security comparison for \`${{ matrix.name }}\`**

            | Scan | MEDIUM+ CVEs |
            |------|-------------|
            | Base | ${base} |
            | PR   | ${pr} |

            Result: ${pr <= base ? "SAFE – can be merged" : "WORSE – blocked"}
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      # Auto-Merge erlauben (nur wenn sicher)
      - name: Enable auto-merge if safe
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.enableAutoMerge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: "squash"
            });
