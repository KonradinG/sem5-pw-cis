name: Deploy Gated by CVEs

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: CVE gate (block on CRITICAL)
        run: |
          if ls cve-baseline/*.json >/dev/null 2>&1; then
            for f in cve-baseline/*.json; do
              IMG=$(basename "$f" .json)
              CRIT=$(jq '.critical' "$f")
              
              # Exception for test images: vote, result, worker
              if [[ "$IMG" == "vote" || "$IMG" == "result" || "$IMG" == "worker" ]]; then
                echo "ℹ️ Test image $IMG has $CRIT CRITICAL CVEs - skipping block (test/demo purposes)"
              elif [ "$CRIT" -gt 0 ]; then
                echo "❌ Blocking deploy: image $IMG has $CRIT CRITICAL CVEs (from $f)"
                exit 1
              fi
            done
            echo "✅ No CRITICAL CVEs in production baselines. Deploy allowed."
          else
            echo "⚠️ No baselines found in cve-baseline/. Decide if you want to block or allow."
            exit 1
          fi

      - name: Deploy (placeholder)
        run: |
          echo "Hier kommt deine eigentliche Deployment-Logik hin."
