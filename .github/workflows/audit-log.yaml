name: Audit Log Update

on:
  workflow_run:
    workflows: ["build-and-scan"]
    types: [completed]

jobs:
  update-audit-log:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - uses: actions/checkout@v4

      - name: Generate audit logs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "all",
              labels: "security",
              per_page: 100,
            });

            if (!issues.length) {
              console.log("No security issues found.");
              return;
            }

            fs.mkdirSync("audit-logs", { recursive: true });

            for (const issue of issues) {
              if (!issue.body) continue;

              const imageLabel = issue.labels.find(l =>
                l.name.startsWith("image:")
              );
              if (!imageLabel) continue;

              const image = imageLabel.name.split(":")[1];

              const scan = issue.body.match(/## Scan[\s\S]*?(?=## Scan|$)/);
              if (!scan) continue;

              const file = `audit-logs/${image}.md`;
              const existing = fs.existsSync(file)
                ? fs.readFileSync(file, "utf8")
                : "";

              if (existing.includes(scan[0])) continue;

              const content =
              `# Audit Log for ${image}

              ${scan[0]}

              Issue: #${issue.number}
              State: ${issue.state}

              ---

              ${existing}`;

              fs.writeFileSync(file, content);
              console.log(`Updated ${file}`);
            }

      - name: Commit audit logs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add audit-logs/*.md || true
          if git diff --staged --quiet; then
            echo "No audit logs to commit"
          else
            git commit -m "Update audit logs"
            git push
          fi
