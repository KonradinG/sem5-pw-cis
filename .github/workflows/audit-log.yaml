name: Audit Log Update

on:
  workflow_run:
    workflows: ["build-and-scan"]
    types:
      - completed

jobs:
  update-audit-log:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1) CVE-Issues abrufen
      - name: Fetch open CVE issues
        id: fetch
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "security",
              per_page: 100
            });

            return { issues: issues.data };

      # 2) issues.json erzeugen
      - name: Write issues.json
        run: |
          mkdir -p audit-logs

          if [ -z "${{ steps.fetch.outputs.issues }}" ]; then
            echo "[]" > issues.json
          else
            echo '${{ steps.fetch.outputs.issues }}' > issues.json
          fi

      # 3) Audit-Logs pro Image generieren
      - name: Update audit logs
        run: |
          node << 'EOF'
          const fs = require("fs");

          let raw = fs.readFileSync("issues.json", "utf8").trim();
          if (!raw) {
            console.log("No issues found — skipping.");
            process.exit(0);
          }

          let issues;
          try {
            issues = JSON.parse(raw);
          } catch (err) {
            console.log("Invalid JSON — skipping.");
            console.log(raw);
            process.exit(0);
          }

          if (!Array.isArray(issues) || issues.length === 0) {
            console.log("No security issues — skipping.");
            process.exit(0);
          }

          for (const issue of issues) {

            if (!issue || !issue.body) continue;

            const imageLabel = issue.labels.find(l => l.name.startsWith("image:"));
            if (!imageLabel) continue;

            const imageName = imageLabel.name.split(":")[1];

            const match = issue.body.match(/## Scan (\d{4}-\d{2}-\d{2})([\s\S]*?)(?=## Scan|$)/);

            if (!match) continue;

            const date = match[1];
            const contents = match[2].trim();

            const auditFile = `audit-logs/${imageName}.md`;

            let oldContent = "";
            if (fs.existsSync(auditFile)) {
              oldContent = fs.readFileSync(auditFile, "utf8");
            }

            const newEntry = 
            `## ${date}
            Issue: #${issue.number}
            ${contents}

            ---`;

                        const finalContent =
            `# Audit Log für Image: ${imageName}

            ${newEntry}

            ${oldContent}`;

                        fs.writeFileSync(auditFile, finalContent);
                      }
                      EOF

      # 4) Commit ins Repo
      - name: Commit audit logs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add audit-logs/*.md || true

          if ! git diff --staged --quiet; then
            git commit -m "Update audit logs"
            git push
          else
            echo "No audit log changes to commit."
          fi
