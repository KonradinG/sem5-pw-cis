// CVE Details Page Logic
// Loads all Trivy reports and displays detailed vulnerability information

(function init() {
  const REPORTS_PATH = "data/trivy-reports/";
  const IMAGES = ["php-mysql", "postgres-18"];
  
  let allCVEs = [];
  let filteredCVEs = [];
  let currentFilter = "all";
  
  const searchInput = document.getElementById("search");
  const tbody = document.getElementById("cve-tbody");
  const filterBtns = document.querySelectorAll(".filter-btn");
  
  // Stats elements
  const statTotal = document.getElementById("stat-total");
  const statCritical = document.getElementById("stat-critical");
  const statHigh = document.getElementById("stat-high");
  const statMedium = document.getElementById("stat-medium");
  const statLow = document.getElementById("stat-low");
  
  /**
   * Load all Trivy reports and extract CVEs
   */
  async function loadCVEs() {
    const cves = [];
    
    for (const image of IMAGES) {
      try {
        const response = await fetch(`${REPORTS_PATH}${image}.json`);
        if (!response.ok) continue;
        
        const data = await response.json();
        const results = data.Results || [];
        
        results.forEach(result => {
          const vulnerabilities = result.Vulnerabilities || [];
          vulnerabilities.forEach(vuln => {
            cves.push({
              id: vuln.VulnerabilityID || "N/A",
              severity: vuln.Severity || "UNKNOWN",
              package: vuln.PkgName || "N/A",
              installed: vuln.InstalledVersion || "N/A",
              fixed: vuln.FixedVersion || "Pending",
              cvss: vuln.CVSS?.nvd?.V3Score || vuln.CVSS?.redhat?.V3Score || "N/A",
              url: vuln.PrimaryURL || `https://nvd.nist.gov/vuln/detail/${vuln.VulnerabilityID}`,
              description: vuln.Description || "",
              image: image,
              title: vuln.Title || ""
            });
          });
        });
      } catch (error) {
        console.error(`Error loading report for ${image}:`, error);
      }
    }
    
    allCVEs = cves;
    filteredCVEs = cves;
    updateStats();
    renderCVEs();
  }
  
  /**
   * Update statistics display
   */
  function updateStats() {
    const stats = {
      total: allCVEs.length,
      critical: allCVEs.filter(c => c.severity === "CRITICAL").length,
      high: allCVEs.filter(c => c.severity === "HIGH").length,
      medium: allCVEs.filter(c => c.severity === "MEDIUM").length,
      low: allCVEs.filter(c => c.severity === "LOW").length
    };
    
    statTotal.textContent = stats.total;
    statCritical.textContent = stats.critical;
    statHigh.textContent = stats.high;
    statMedium.textContent = stats.medium;
    statLow.textContent = stats.low;
  }
  
  /**
   * Render CVE table
   */
  function renderCVEs() {
    if (filteredCVEs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="loading-text">Keine CVEs gefunden</td></tr>';
      return;
    }
    
    // Sort by severity (CRITICAL > HIGH > MEDIUM > LOW > UNKNOWN)
    const severityOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, UNKNOWN: 4 };
    const sorted = [...filteredCVEs].sort((a, b) => {
      const orderA = severityOrder[a.severity] ?? 5;
      const orderB = severityOrder[b.severity] ?? 5;
      if (orderA !== orderB) return orderA - orderB;
      return a.id.localeCompare(b.id);
    });
    
    tbody.innerHTML = sorted.map(cve => `
      <tr>
        <td>
          <a href="${cve.url}" target="_blank" class="cve-link" title="${cve.description || cve.title}">
            ${cve.id}
          </a>
        </td>
        <td><span class="badge badge-${cve.severity.toLowerCase()}">${cve.severity}</span></td>
        <td><code>${cve.package}</code></td>
        <td>${cve.installed}</td>
        <td>${cve.fixed}</td>
        <td>${cve.cvss}</td>
        <td>${cve.image}</td>
      </tr>
    `).join('');
  }
  
  /**
   * Apply search and filter
   */
  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    
    filteredCVEs = allCVEs.filter(cve => {
      // Apply severity filter
      if (currentFilter !== "all" && cve.severity !== currentFilter) {
        return false;
      }
      
      // Apply search filter
      if (searchTerm) {
        const searchableText = `
          ${cve.id} 
          ${cve.package} 
          ${cve.description} 
          ${cve.title}
          ${cve.image}
        `.toLowerCase();
        
        if (!searchableText.includes(searchTerm)) {
          return false;
        }
      }
      
      return true;
    });
    
    renderCVEs();
  }
  
  /**
   * Set up event listeners
   */
  function setupListeners() {
    // Search input
    searchInput.addEventListener("input", applyFilters);
    
    // Filter buttons
    filterBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        // Update active state
        filterBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        
        // Update filter
        currentFilter = btn.dataset.severity;
        applyFilters();
      });
    });
  }
  
  // Initialize
  setupListeners();
  loadCVEs();
})();
